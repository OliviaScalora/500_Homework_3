---
title: "The Application of Logistic Regression to Examine the Predictors of Car Crashes Caused by Alcohol"
author: "Olivia Scalora and Briana Cervantes"
date: "11/22/2021"
output:
  html_document:
    toc: true 
    toc_float: true 
    toc_depth: 6
    theme: yeti
    highlight: textmate
    code_folding: "hide"
    css: style.css
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(aod)
library(ggplot2)
library(rms)
library(gmodels)
library(boot)
library(DAAG)
library(ROCR)
library(tidyr)
library(dplyr)
library(MASS)
library(rsq)
library(kableExtra)
library(tidyverse) #for ggplot
#library(sf) #for maps
#library(cowplot) #for plotgrid
library(classInt)#for jenks breaks
library(rgdal)
library(RColorBrewer)
library(broom)
library(maptools)
library(spdep)
library(spgwr)
library(rgeos)
library(ape)
library(tmap)
library(sp)
library(spatialreg)
library(kableExtra)
library(knitr)
#install.packages('DT')
library(DT)

mydata <- read.csv("https://raw.githubusercontent.com/OliviaScalora/500_Homework_3/main/Logistic Regression Data.csv")
head(mydata)

```

# INTRODUCTION

**a) State the problem, the importance of the problem, and the setting of the analysis (Philadelphia)**

**b) Speculate as to why the predictors weâ€™re using might be associated with the response variable.**

**c) Indicate that you will be using R to run logistic regression for the analysis.**

# METHODS

**a) Explain the problems with using OLS regression when the dependent variable is binary**

**b) Explain how logistic regression works around these issues.**

**c) Describe the hypothesis that is tested for each predictor**  

    
**d) Talk about how you assess the quality of model fit.**  

**e) Talk about the assumptions of logistic regression.**

**f) Describe the exploratory analyses that statisticians may want to do before running logistic regression.**
    
# RESULTS
**a) Present and discuss the results of the exploratory analyses.**
```{r cross.tab, include = TRUE, warning=FALSE, message=FALSE,results='hide'}
Cross_Fatal<-CrossTable(mydata$FATAL_OR_M, mydata$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE, chisq=TRUE)
Cross_Fatal_tbl<-
  cbind(as.data.frame(Cross_Fatal$t)%>%filter(x==1)%>%rename(N=Freq),
        as.data.frame(Cross_Fatal[["prop.tbl"]])%>%filter(x==1)%>%rename('percentage'=Freq,x1=x,y1=y))%>%
  dplyr::select(-x1,-y1)%>%
  mutate(Variable='FATAL_OR_M')
         

#.ii
Cross_Over<- CrossTable(mydata$OVERTURNED, mydata$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE, chisq=TRUE)
Cross_Over_tbl<-
  cbind(as.data.frame(Cross_Over$t)%>%filter(x==1)%>%rename(N=Freq),
      as.data.frame(Cross_Over[["prop.tbl"]])%>%filter(x==1)%>%rename('percentage'=Freq,x1=x,y1=y))%>%
  dplyr::select(-x1,-y1)%>%
  mutate(Variable='OVERTURNED')

Cross_Cell<-CrossTable(mydata$CELL_PHONE, mydata$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE, chisq=TRUE)
Cross_Cell_tbl<-
  cbind(as.data.frame(Cross_Cell$t)%>%filter(x==1)%>%rename(N=Freq),
        as.data.frame(Cross_Cell[["prop.tbl"]])%>%filter(x==1)%>%rename('percentage'=Freq,x1=x,y1=y))%>%
  dplyr::select(-x1,-y1)%>%
  mutate(Variable='CELL_PHONE')

Cross_Speed<-CrossTable(mydata$SPEEDING, mydata$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE, chisq=TRUE)
Cross_Speed_tbl<-
  cbind(as.data.frame(Cross_Speed$t)%>%filter(x==1)%>%rename(N=Freq),
        as.data.frame(Cross_Speed[["prop.tbl"]])%>%filter(x==1)%>%rename('percentage'=Freq,x1=x,y1=y))%>%
  dplyr::select(-x1,-y1)%>%
  mutate(Variable='SPEEDING')

Cross_Agg<-CrossTable(mydata$AGGRESSIVE, mydata$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE, chisq=TRUE)
Cross_Agg_tbl<-
  cbind(as.data.frame(Cross_Agg$t)%>%filter(x==1)%>%rename(N=Freq),
        as.data.frame(Cross_Agg[["prop.tbl"]])%>%filter(x==1)%>%rename('percentage'=Freq,x1=x,y1=y))%>%
  dplyr::select(-x1,-y1)%>%
  mutate(Variable='AGGRESSIVE')

Cross_1617<-CrossTable(mydata$DRIVER1617, mydata$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE, chisq=TRUE)
Cross_1617_tbl<-
  cbind(as.data.frame(Cross_1617$t)%>%filter(x==1)%>%rename(N=Freq),
        as.data.frame(Cross_1617[["prop.tbl"]])%>%filter(x==1)%>%rename('percentage'=Freq,x1=x,y1=y))%>%
          dplyr::select(-x1,-y1)%>%
          mutate(Variable='DRIVER1617')

Cross_65P<-CrossTable(mydata$DRIVER65PLUS, mydata$DRINKING_D, prop.r=FALSE, prop.t=FALSE, prop.chisq=FALSE, chisq=TRUE)
Cross_65P_tbl<-
  cbind(as.data.frame(Cross_65P$t)%>%filter(x==1)%>%rename(N=Freq),
        as.data.frame(Cross_65P[["prop.tbl"]])%>%filter(x==1)%>%rename('percentage'=Freq,x1=x,y1=y))%>%
  dplyr::select(-x1,-y1)%>%
  mutate(Variable='DRIVER65PLUS')

# Putting table together - there might be a simpler way of doing this but this ends up working
Cross_Joined<-rbind(Cross_Fatal_tbl,Cross_Over_tbl,Cross_Cell_tbl,Cross_Speed_tbl,Cross_Agg_tbl,Cross_1617_tbl,Cross_65P_tbl)

CrossTablex<- Cross_Joined %>%spread(x, Variable)%>%filter(y==0)%>%rename(N_1=N,'percentage_1' = 'percentage')
CrossTabley<- Cross_Joined %>%spread(x, Variable)%>%filter(y==1)%>%
  dplyr::select(-y,-'1')%>%
  cbind(CrossTablex)%>%dplyr::select(-y)%>%rename(Variable = '1')
CrossTable<-CrossTabley%>%mutate(Total_N = N+N_1,
         '%' = round((percentage *100),2),
         '%_1' = round((percentage_1 *100),2))%>% dplyr::select(-percentage, -percentage_1)%>%
  arrange(factor(Variable, levels = c('FATAL_OR_M', 'OVERTURNED', 
                                      'CELL_PHONE', 'SPEEDING', 
                                      'AGGRESSIVE', 'DRIVER1617', 
                                      'DRIVER65PLUS')))%>%
  bind_cols(data.frame(Description = c(
  "Crash resulted in fatality or major injury",
  "Crash involved an overturned vehicle",
  "Driver was using cell phone",
  "Crash involved speeding vat",
  "Crash involved aggressive driving",
  "Crash involved at least one driver who was 16 or 17 years old",
  "Crash involved at least one driver who was at least 65 years old")))%>%
  bind_cols(data.frame('X2 p.value' = c(
    Cross_Fatal[["chisq"]][["p.value"]],
    Cross_Over[["chisq"]][["p.value"]],
    Cross_Cell[["chisq"]][["p.value"]],
    Cross_Speed[["chisq"]][["p.value"]],
    Cross_Agg[["chisq"]][["p.value"]],
    Cross_1617[["chisq"]][["p.value"]],
    Cross_65P[["chisq"]][["p.value"]])))
```

```{r cross.tab.ouput, include = TRUE, echo= FALSE, warning=FALSE, message=FALSE, fig.width=8, fig.height=5 }

CrossTable[, c(3,7,1,5,2,6,4,8)]%>%
  kable(col.names = c("Variable", "","N","%","N","%","N", "X2 P.value"),
                                     align = c('r','l','c','c','c','c','c','c'))%>%
  kable_material()%>%
  add_header_above(c("","","No Alcohol Involved\n(Drinkind_D = 0)" = 2, "Alcohol Involved\n(Drinkind_D = 1)" = 2,"Total", ""),
                                                align = c('r','c'))%>%
  column_spec(1,bold = TRUE)%>%
  column_spec(5,border_left = TRUE)%>%
  column_spec(c(3:4),background = '#f1f1f1')%>%
  column_spec(c(5:6),background = '#e1e1e1')

```

```{r sd.mean.tab, include = TRUE, warning=FALSE, message=FALSE,results='hide'}
#Means by group
meanbach<-as.data.frame(t(tapply(mydata$PCTBACHMOR, mydata$DRINKING_D, mean)))%>%mutate(Variable= 'PCTBACHMOR')%>%
  rename('mean.0'='0', 'mean.1'='1')
# 16.56986 16.61173 

meanHHinc<-as.data.frame(t(tapply(mydata$MEDHHINC, mydata$DRINKING_D, mean)))%>%mutate(Variable= 'MEDHHINC')%>%
  rename('mean.0'='0', 'mean.1'='1')
# 31483.05 31998.75 

#SD by group
sdbach<-as.data.frame(t(tapply(mydata$PCTBACHMOR, mydata$DRINKING_D, sd)))%>%mutate(Variable= 'PCTBACHMOR')%>%
  rename('sd.0'='0', 'sd.1'='1')
# 18.21426 18.72091

sdHHinc<-as.data.frame(t(tapply(mydata$MEDHHINC, mydata$DRINKING_D, sd)))%>%mutate(Variable= 'MEDHHINC')%>%
  rename('sd.0'='0', 'sd.1'='1')
# 16930.1 17810.5

#save pvalues for table (step iii). 
ttest_pvalues<-as.data.frame(c((t.test(mydata$PCTBACHMOR~mydata$DRINKING_D)$p.value),
                               (t.test(mydata$MEDHHINC~mydata$DRINKING_D)$p.value)))

#ii.
#Mean and SD table
MeanSD_tbl<- merge(x=(merge(x=meanHHinc, y=sdHHinc, all= TRUE)),
                   y=(merge(x=meanbach, y=sdbach,all=TRUE)),
                   all=TRUE)%>%arrange(desc(Variable))%>%
  bind_cols(data.frame(Description = c(
    "% with a bachelor's degree or more",
    "Median household income")))%>%
  bind_cols(ttest_pvalues)
```

```{r sd.mean.tabouput, include = TRUE, echo= FALSE, warning=FALSE, message=FALSE, fig.width=8, fig.height=5 }
#output for markdown
MeanSD_tbl[, c(1,6,2,4,3,5,7)]%>%
  kable(col.names = c("Variable","","Mean","SD","Mean","SD","t-test p-value"),
                                     align = c('r','l','c','c','c','c','c'))%>%
  kable_material()%>%
  add_header_above(c("","","No Alcohol Involved\n(Drinkind_D = 0)" = 2,
                     "Alcohol Involved\n(Drinkind_D = 1)" = 2,""),
                   align = c('r','c'))%>%
  column_spec(1,bold = TRUE)%>%
  column_spec(5,border_left = TRUE)%>%
  column_spec(c(3:4),background = '#f1f1f1')%>%
  column_spec(c(5:6),background = '#e1e1e1')
```

**b) Comment on which logistic regression assumptions are met and which ones are violated for the problem at hand.**

```{r corr.mat, include = TRUE, echo= FALSE, warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
pred_var <- mydata%>%dplyr::select(DRINKING_D, FATAL_OR_M, OVERTURNED, CELL_PHONE, SPEEDING,
                                   AGGRESSIVE,DRIVER1617,DRIVER65PLUS,PCTBACHMOR,MEDHHINC)
pcorr <- cor(pred_var, method="pearson")

#correlation matrix for markdown
pcorr%>%kable()%>%kable_styling(full_width=FALSE)%>%kable_material()%>%
  column_spec(1,bold = TRUE)
```

**c) Present the logistic regression results**

# DISCUSSION

**a) In a couple sentences, recap what you did in the paper, and your findings.**

**b) What are some limitations of the analysis? Discuss.**